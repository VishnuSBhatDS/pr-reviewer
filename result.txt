Question: public ResponseEntity<?> addUpdateCart(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                                           @RequestHeader(name = "appVersion") String appVersion,
                                           @RequestHeader(name = "pincode", required = false) String pincode,
                                           @RequestHeader(name = "palId", required = false) Integer palId,
                                           @RequestParam(name = "source", defaultValue = "B2C", required = false) String source, /** for internal call*/
                                           @RequestParam(name = "userId", required = false) Long userId, /** for internal call*/
                                           @RequestHeader(name = "userId", required = false) Long headerUserId,
                                           @Valid @RequestBody CartUpdateRequestModel cartUpdateRequestModel,
                                           HttpServletRequest httpServiceRequest,
                                           @RequestHeader(name = "platform", required = false, defaultValue = ANDROID) String platform,
                                           @RequestHeader(name = "deviceId", required = false, defaultValue = "") String deviceId,
                                           @RequestHeader(name = "Appsflyer-Uid", required = false, defaultValue = "") String appsflyerUid,
                                           @RequestHeader(name = "advertisingId", required = false, defaultValue = "") String advertisingId,
                                           @RequestHeader(name = "addressId", required = false, defaultValue = "0") Long addressId) {
        Lo


ðŸ“„ FILE: PaymentControllerV5.java

--- payment-service | PaymentControllerV5 | getPaymentMethods | CODE | 1/1 ---
    @PostMapping(value = "/payment-methods")
    public ResponseEntity<?> getPaymentMethods(
            @RequestHeader(value = "appVersion", required = false) String appVersion,
            @RequestHeader(value = "lang", defaultValue = "en") String lang,
            @RequestBody PaymentMethodsRequestModel paymentMethodsRequestModel ,
            @RequestHeader(name = "userId", required = false) Long headerUserId,
            @RequestHeader(value = "platform", defaultValue = ANDROID , required = false) String platform,
            HttpServletRequest request) throws Exception {
        paymentMethodsRequestModel.getUpdateOrderModel().setUserId(commonUtils.getFinalValidUserId(request, headerUserId));
        paymentMethodsRequestModel.getUpdateOrderModel().setPlatform(platform);
        return new ResponseEntity<>(paymentServiceV5.getPaymentMethods(paymentMethodsRequestModel, lang),


ðŸ“„ FILE: PaymentControllerV4.java

--- payment-service | PaymentControllerV4 | getPaymentMethods | CODE | 1/1 ---
    @PostMapping(value = "/payment-methods")
    public ResponseEntity<?> getPaymentMethods(
        @RequestHeader(value = "appVersion", required = false) String appVersion,
        @RequestHeader(value = "lang", defaultValue = "en") String lang,
        @RequestHeader(name = "userId", required = false) Long headerUserId,
        @RequestBody UpdateOrderModel updateOrderModel,
        HttpServletRequest request,
        @RequestHeader(value = "platform", defaultValue = ANDROID , required = false) String platform) throws Exception {
        updateOrderModel.setUserId(
                commonUtils.getFinalValidUserId(request, headerUserId));
        if (appVersion != null) {
            updateOrderModel.setAppVersion(appVersion);
        }
        updateOrderModel.setPlatform(platform);

        return new ResponseEntity<>(paymentServiceV4.getPaymentMethods(updateOrderModel, lang),


ðŸ“„ FILE: PaymentControllerV3.java

--- payment-service | PaymentControllerV3 | getPaymentMethods | CODE | 1/1 ---
    @PostMapping(value = "/payment-methods")
    public ResponseEntity<?> getPaymentMethods(
        @RequestHeader(value = "appVersion", required = false) String appVersion,
        @RequestHeader(value = "lang", defaultValue = "en") String lang,
        @RequestHeader(name = "userId", required = false) Long headerUserId,
        @RequestBody UpdateOrderModel updateOrderModel,
        HttpServletRequest request,
        @RequestHeader(value = "platform", defaultValue = ANDROID , required = false) String platform) throws Exception {
        updateOrderModel.setUserId(
            commonUtils.getFinalValidUserId(request, headerUserId));
        if (appVersion != null) {
            updateOrderModel.setAppVersion(appVersion);
        }
        updateOrderModel.setPlatform(platform);
        return new ResponseEntity<>(paymentServiceV3.getPaymentMethods(updateOrderModel, lang),

--- payment-service | PaymentControllerV3 | initPayment | CODE | 1/1 ---
    @PostMapping(value = "/init-payment")
    public ResponseEntity<?> initPayment(@RequestBody InitPaymentRequestModel initPaymentRequestModel,
                                         @RequestHeader(value = "palId", required = false) Integer palId,
                                         @RequestHeader(name = "userId", required = false) Long headerUserId,
                                         @RequestHeader(value = "platform", defaultValue = ANDROID , required = false) String platform,
                                         @RequestHeader(value = "Appsflyer-Uid", required = false) String appsFlyerId,
                                         @RequestHeader(value = "deviceId" , required = false) String deviceId,
                                         @RequestHeader(value = "advertisingId" , required = false, defaultValue = "") String advertisingId,
                                         @RequestHeader(value = "instanceId", required = false) String instanceId,
                                         HttpServletRequest request) {
        try {


ðŸ“„ FILE: PaymentControllerV2.java

--- payment-service | PaymentControllerV2 | getPaymentMethods | CODE | 1/1 ---
    @PostMapping(value = "/payment-methods")
    public ResponseEntity<?> getPaymentMethods(@RequestHeader (value = "appVersion", required = false) String appVersion,
                                            @RequestHeader(value = "lang", defaultValue = "en") String lang,
                                            @RequestHeader(name = "userId", required = false) Long headerUserId,
                                            @RequestBody UpdateOrderModel updateOrderModel,
                                            HttpServletRequest request,
                                            @RequestHeader (value = "platform", defaultValue = ANDROID, required = false) String platform) throws IOException, RazorpayException {
        updateOrderModel.setUserId(commonUtils.getFinalValidUserId(request, headerUserId));
        if (appVersion != null) {
            updateOrderModel.setAppVersion(appVersion);
        }
        updateOrderModel.setPlatform(platform);
        return new ResponseEntity<>(paymentServiceV2.getPaymentMethods(updateOrderModel, lang), HttpStatus.OK);


ðŸ“„ FILE: CartControllerV2Test.java

--- cart-service | CartControllerV2Test | testSnapshotCart_WithHeaderUserId_UsesHeaderUserId | TEST | 1/1 ---
    @Test
    void testSnapshotCart_WithHeaderUserId_UsesHeaderUserId() throws Exception {
        // Given
        Long userId = 123L;
        Long headerUserId = 456L;
        String appVersion = "1.0.0";
        String pincode = "110001";
        String platform = ANDROID;
        Long palId = 1L;
        Long addressId = 1L;

        ResponseEntity<?> expectedResponse = ResponseEntity.ok().build();
        when(cartServiceV2.validateUserCart(any(CartModel.class), eq(headerUserId), eq(pincode), eq(appVersion), eq(platform), eq(palId), any(CartParamsTransferModelDTO.class)))
                .thenReturn(ResponseEntity.ok().build());

        // When
        ResponseEntity<?> result = cartControllerV2.snapshotCart(testCartModel, userId, headerUserId, appVersion, pincode, request, platform, palId, addressId);

        // Then
        assertNotNull(result);
        verify(commonUtils, never()).getFinalValidUserId(any(), any());
        verify(cartServiceV2).validateUserCart(any(CartModel.class), eq(headerUserId), eq(pincode), eq(appVersion), eq(platform), eq(palId), any(CartParamsTransferModelDTO.class));

--- cart-service | CartControllerV2Test | testPlaceOrder_WithUpdateCartStatusException_ThrowsException | TEST | 1/1 ---
    @Test
    void testPlaceOrder_WithUpdateCartStatusException_ThrowsException() throws Exception {
        // Given
        String source = "B2C";
        String lang = "en";
        String authKey = "authKey";
        String authorizationRefresh = "refreshKey";
        int cpVersion = 1;
        String pincode = "110001";
        String appVersion = "1.0.0";
        Integer palId = 1;
        Long userId = 123L;
        Long headerUserId = null;
        String appType = "B2C";
        String platform = ANDROID;
        String appsFlyerId = "appsFlyerId";
        String deviceId = "deviceId";
        String requestId = "requestId";
        String visitorId = "visitorId";
        String lat = "28.6139";
        String lng = "77.2090";
        String advertisingId = "advertisingId";
        String instanceId = "instanceId";
        Long addressId = 1L;

        when(commonUtils.getFinalValidUserId(request, userId)).thenReturn(userId);
        when(request.getAttribute(RequestAttributeConstant.TOKEN_SOURCE)).thenReturn("B2C");
        when(cartServiceV2.checkTokenSource("B2C", "B2C", "B2C")).thenReturn(true);
        when(cartServiceV2.placeOrderV2(any(CartOrderModel.class), eq(lang), eq(source), eq(userId), eq(cpVersion), eq(pincode), eq(appVersion), eq(palId), eq(platform), eq(authorizationRefresh), eq(appsFlyerId), eq(deviceId), any(CartParamsTransferModelDTO.class)))
                .thenThrow(new UpdateCartStatusException("Cart update failed"));

        // When & Then
        assertThrows(UpdateCartStatusException.class, () ->


ðŸ“„ FILE: RecommendationServiceImplTest.java

--- cart-service | RecommendationServiceImplTest | setup | TEST | 1/1 ---
    @Before
    public void setup() {
        // Setup common test data
        requestModel = new CartRecommendationRequestModel();
        requestModel.setVariant("cart-addons");
        
        LocationInfo locationInfo = new LocationInfo();
        locationInfo.setPincode("560001");
        locationInfo.setCityId(10L);
        locationInfo.setStateId(20L);
        requestModel.setLocationInfo(locationInfo);
        
        UserInfo userInfo = new UserInfo();
        userInfo.setUserId(123L);
        userInfo.setUserRank("normal");
        requestModel.setUserInfo(userInfo);
        
        requestModel.setLang("en");
        requestModel.setSource("android");
        
        // Create sample response model
        responseModel = new CartRecommendationResponseModel();
        responseModel.setMessage("Test Message");
        responseModel.setView(RecommendationWidgetPositionEnum.TOP);
        
        List<DealListModel> deals = new ArrayList<>();
        DealListModel deal = new DealListModel();
        deal.setId(1L);
        deal.setDealId("1");
        deal.setTitle("Test Deal");
        deals.add(deal);
        responseModel.setDealDetails(deals);


ðŸ“„ FILE: CartControllerV4.java

--- cart-service | CartControllerV4 | addUpdateCart | CODE | 1/1 ---
    @PutMapping()
    public ResponseEntity<?> addUpdateCart(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                                           @RequestHeader(name = "appVersion") String appVersion,
                                           @RequestHeader(name = "pincode", required = false) String pincode,
                                           @RequestHeader(name = "palId", required = false) Integer palId,
                                           @RequestParam(name = "source", defaultValue = "B2C", required = false) String source, /** for internal call*/
                                           @RequestParam(name = "userId", required = false) Long userId, /** for internal call*/
                                           @RequestHeader(name = "userId", required = false) Long headerUserId,
                                           @Valid @RequestBody CartUpdateRequestModel cartUpdateRequestModel,
                                           HttpServletRequest httpServiceRequest,
                                           @RequestHeader(name = "platform", required = false, defaultValue = ANDROID) String platform,
                                           @RequestHeader(name = "deviceId", required = false, defaultValue = "") String deviceId,
                                           @RequestHeader(name = "Appsflyer-Uid", required = false, defaultValue = "") String appsflyerUid,
                                           @RequestHeader(name = "advertisingId", required = false, defaultValue = "") String advertisingId,
                                           @RequestHeader(name = "addressId", required = false, defaultValue = "0") Long addressId) {
        Long finalUserId = Objects.isNull(headerUserId) ? userId : headerUserId;
        Map<String, String> tokenDataMap = commonUtils.getTokenData(httpServiceRequest, finalUserId, source);
        if ( ! ObjectUtils.isEmpty(pincode)) {
            cartUpdateRequestModel.setPincode(Long.valueOf(pincode));
        }

        CartParamsTransferModelDTO cartParamsTransferModelDTO = new CartParamsTransferModelDTO();
        cartParamsTransferModelDTO.setDeviceId(deviceId);
        cartParamsTransferModelDTO.setAppsFlyerId(appsflyerUid);
        cartParamsTransferModelDTO.setAdvertisingId(advertisingId);
        cartParamsTransferModelDTO.setPlatform(platform);
        cartParamsTransferModelDTO.setAddressId(addressId);
        cartParamsTransferModelDTO.setPalId(palId == null ? 0L : Long.valueOf(palId));
        cartUpdateRequestModel.setAddressId(addressId);

        return commonUtils.prepareSuccessResponseModel(

--- cart-service | CartControllerV4 | cartMinView | CODE | 1/1 ---
    @RateLimiter(name = "getCartMinViewRateLimiter")
    @GetMapping("/min-view")
    public ResponseEntity<?> cartMinView(
            @RequestHeader(name = "appVersion") String appVersion,
            @NotNull @Min(value = 100000) @Max(value = 999999) @RequestParam(name = "pincode") Long pincode,
            @RequestParam(name = "source", defaultValue = "B2C", required = false) String source, /** for internal call*/
            @RequestParam(name = "userId", required = false) Long userId, /** for internal call*/
            @RequestHeader(name = "userId", required = false) Long headerUserId,
            HttpServletRequest httpServiceRequest,
            @RequestHeader(name = "platform", required = false, defaultValue = ANDROID) String platform) {
        Long finalUserId = Objects.isNull(headerUserId) ? userId : headerUserId;
        Map<String, String> tokenDataMap = commonUtils.getTokenData(httpServiceRequest, finalUserId, source);
        return  commonUtils.prepareSuccessResponseModel(

--- cart-service | CartControllerV4 | getCart | CODE | 1/1 ---
    @RateLimiter(name = "getCartRateLimiter")
    @GetMapping
    public ResponseEntity<?> getCart(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                                     @RequestHeader(name = "appVersion") String appVersion,
                                     @RequestHeader(name = "palId", required = false) Integer palId,
                                     @NotNull @Min(value = 100000) @Max(value = 999999) @RequestParam(name = "pincode") Long pincode,
                                     @RequestParam(name = "applyRefund", required = false, defaultValue = "true") Boolean applyRefund,
                                     @RequestParam(name = "applyWalletCashback", required = false, defaultValue = "true") Boolean applyWalletCashback,
                                     @RequestParam(name = "source", defaultValue = "B2C", required = false) String source, /** for internal call*/
                                     @RequestParam(name = "userId", required = false) Long userId, /** for internal call*/
                                     @RequestHeader(name = "userId", required = false) Long headerUserId,
                                     HttpServletRequest httpServiceRequest,
                                     @RequestHeader(name = "platform", required = false, defaultValue = ANDROID) String platform,
                                     @RequestHeader(name = "juspayEnabled", required = false, defaultValue = "true") Boolean juspayEnabled,
                                    @RequestHeader(name = "addressId", required = false, defaultValue = "0") Long addressId){

        juspayEnabled = true;
        Long finalUserId = Objects.isNull(headerUserId) ? userId : headerUserId;
        Map<String, String> tokenDataMap = commonUtils.getTokenData(httpServiceRequest, finalUserId, source);

        CartParamsTransferModelDTO cartParamsTransferModelDTO = new CartParamsTransferModelDTO();
        cartParamsTransferModelDTO.setPlatform(platform);
        cartParamsTransferModelDTO.setAddressId(addressId);
        cartParamsTransferModelDTO.setAddressId(addressId);
        cartParamsTransferModelDTO.setPalId(palId == null ? 0L : Long.valueOf(palId));

        return  commonUtils.prepareSuccessResponseModel(

--- cart-service | CartControllerV4 | updateCart | CODE | 1/1 ---
    @PostMapping()
    public ResponseEntity<?> updateCart(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                                        @RequestHeader(name = "appVersion") String appVersion,
                                        @RequestHeader(name = "pincode", required = false) String pincode,
                                        @RequestHeader(name = "palId", required = false) Integer palId,
                                        @Valid @RequestBody CartUpdateRequestModel cartUpdateRequestModel,
                                        @RequestParam(name = "userId", required = false) Long userId, /** for internal call*/
                                        @RequestHeader(name = "userId", required = false) Long headerUserId,
                                        @RequestParam(name = "source", defaultValue = "B2C", required = false) String source, /** for internal call*/
                                        HttpServletRequest httpServiceRequest,
                                        @RequestHeader(name = "platform", required = false, defaultValue = ANDROID) String platform,
                                        @RequestHeader(name = "juspayEnabled", required = false, defaultValue = "true") Boolean juspayEnabled,
                                        @RequestHeader(name = "deviceId", required = false, defaultValue = "") String deviceId,
                                        @RequestHeader(name = "Appsflyer-Uid", required = false, defaultValue = "") String appsflyerUid,
                                        @RequestHeader(name = "advertisingId", required = false, defaultValue = "") String advertisingId,
                                        @RequestHeader(name = "instanceId", required = false, defaultValue = "") String instanceId,
                                        @RequestHeader(name = "addressId", required = false, defaultValue = "0") Long addressId) {
        juspayEnabled = true;
        Long finalUserId = Objects.isNull(headerUserId) ? userId : headerUserId;
        Map<String, String> tokenDataMap = commonUtils.getTokenData(httpServiceRequest, finalUserId, source);

        CartParamsTransferModelDTO cartParamsTransferModelDTO = new CartParamsTransferModelDTO();
        cartParamsTransferModelDTO.setDeviceId(deviceId);
        cartParamsTransferModelDTO.setAppsFlyerId(appsflyerUid);
        cartParamsTransferModelDTO.setAdvertisingId(advertisingId);
        cartParamsTransferModelDTO.setInstanceId(instanceId);
        cartParamsTransferModelDTO.setPlatform(platform);
        cartParamsTransferModelDTO.setAddressId(addressId);
        cartUpdateRequestModel.setAddressId(addressId);
        cartParamsTransferModelDTO.setPalId(palId == null ? 0L : Long.valueOf(palId));
        return commonUtils.prepareSuccessResponseModel(

--- cart-service | CartControllerV4 | getPageStrip | CODE | 1/1 ---
    @RateLimiter(name = "getHomePageStrip")
    @PostMapping("/home")
    public ResponseEntity<?> getPageStrip(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                                          @RequestBody @Valid HomePageStripRequest homePageStripRequest,
                                          @RequestParam(name = "userId", required = false) Long userId,
                                          @RequestHeader(name = "userId", required = false) Long headerUserId,
                                          @RequestHeader(name = "pincode", required = false) Long pincode,
                                          @RequestHeader(name = "palId", required = false) Long palId,
                                          HttpServletRequest request)  {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        return commonUtils.prepareSuccessResponseModel(


ðŸ“„ FILE: OfferCommController.java

--- cart-service | OfferCommController | getAllProductPromotions | CODE | 1/1 ---
    @PostMapping("/v1/cart/product-promotions")
    public ResponseEntity<?>
    getAllProductPromotions(@RequestHeader(name = "Accept-Language", defaultValue = "en", required = false) String lang,
                            @RequestBody @Valid HomePageStripRequest homePageStripRequest,
                            @RequestParam(name = "userId", required = false) Long userId,
                            @RequestHeader(name = "userId", required = false) Long headerUserId,
                            @RequestHeader(name = "pincode", required = false) Long pincode,
                            @RequestHeader(name = "palId", required = false) Long palId,
                            HttpServletRequest request) {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        return commonUtils.prepareSuccessResponseModel(


ðŸ“„ FILE: CartRecommendationController.java

--- cart-service | CartRecommendationController | getCartRecommendationDeals | CODE | 1/1 ---
    @RateLimiter(name = "getCartRecommendationRateLimiter")
    @GetMapping(value = "/get-cart-recommendation/{variant}")
    public ResponseEntity<?> getCartRecommendationDeals(@PathVariable(value = "variant") String variant,
                                                        @RequestHeader(value = "Accept-Language", defaultValue = "en", required = false) String lang,
                                                        @RequestHeader(value = "pincode") String pincode,
                                                        @RequestParam(value = "source", defaultValue = "app", required = false) String source,
                                                        @RequestParam(name = "userId", required = false) Long userId,
                                                        @RequestHeader(name = "userId", required = false) Long headerUserId,
                                                        @RequestHeader(name = "palId", required = false) Integer palId,
                                                        HttpServletRequest request) throws CartRecommendationNotFoundException {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        return new ResponseEntity<>(cartRecommendationService.getCartRecommendationDeals(variant, userIdFinal, lang, pincode, source, palId), HttpStatus.OK);


ðŸ“„ FILE: CartControllerV2.java

--- cart-service | CartControllerV2 | snapshotCart | CODE | 1/1 ---
    @PostMapping("/validation")
    public ResponseEntity<?> snapshotCart(@RequestBody CartModel cartModel,
                                          @RequestParam(name = "userId", required = false) Long userId,
                                          @RequestHeader(name = "userId", required = false) Long headerUserId,
                                          @RequestHeader(value = "appVersion", required = false) String appVersion,
                                          @RequestHeader(value = "pincode", required = false) String pincode,
                                        HttpServletRequest request,
                                          @RequestHeader(value = "platform", defaultValue = ANDROID, required = false) String platform,
                                          @RequestHeader(value = "palId", required = false) Long palId,
                                          @RequestHeader(value = "addressId", required = false, defaultValue = "0") Long addressId) throws Exception {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        CartParamsTransferModelDTO cartParamsTransferModelDTO = new CartParamsTransferModelDTO(null, null, platform, null, null, null, addressId, palId, null);
        return cartServiceV2.validateUserCart(cartModel, userIdFinal, pincode, appVersion, platform, palId,cartParamsTransferModelDTO);

--- cart-service | CartControllerV2 | placeOrder | CODE | 1/2 ---
    @PostMapping("/order")
    public ResponseEntity<?> placeOrder(@RequestBody CartOrderModel cartOrderModel,
                                        @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                        @RequestHeader(value = "lang", defaultValue = "en") String lang,
                                        @RequestHeader(value = "Authorization") String authKey,
                                        @RequestHeader(value = "Authorization-Refresh", required = false) String authorizationRefresh,
                                        @RequestHeader(value = "cpVersion", defaultValue = "0", required = false) int cpVersion,
                                        @RequestHeader(value = "pincode", required = false) String pincode,
                                        @RequestHeader(value = "appVersion", required = false) String appVersion,
                                        @RequestHeader(value = "palId", required = false) Integer palId,
                                        @RequestParam(name = "userId", required = false) Long userId,
                                        @RequestHeader(name = "userId", required = false) Long headerUserId,
                                        @RequestHeader(name = "appType", required = false) String appType,
                                        HttpServletRequest request,
                                        @RequestHeader(value = "platform", defaultValue = ANDROID, required = false) String platform,
                                        @RequestHeader(value = "Appsflyer-Uid", required = false) String appsFlyerId,
                                        @RequestHeader(value = "deviceId" , required = false) String deviceId,
                                        @RequestHeader(value = "requestId" , required = false) String requestId,
                                        @RequestHeader(value = "visitorId" , required = false) String visitorId,
                                        @RequestHeader(value = "lat" , required = false) String lat,
                                        @RequestHeader(value = "lng" , required = false) String lng,
                                        @RequestHeader(value = "advertisingId" , required = false, defaultValue = "") String advertisingId,
                                        @RequestHeader(value = "instanceId" , required = false, defaultValue = "") String instanceId,
                                        @RequestHeader(value = "addressId", required = false, defaultValue = "0") Long addressId) throws Exception {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        try {
            String tokenSource = ObjectUtils.isEmpty(appType)
                    ? (String) request.getAttribute(RequestAttributeConstant.TOKEN_SOURCE) : appType;
            String requestSource = cartOrderModel.getSource();
            if(StringUtils.isEmpty(tokenSource)){
                //only providing required details
                log.error("EMPTY_TOKEN_SOURCE_RECEIVED - userPhone : {}, cartId: {}, appVersion: {}, platform: {}",
                        cartOrderModel.getUserPhone(),cartOrderModel.getCartId(),cartOrderModel.getAppVersion(), platform);

            }
            else if (! cartServiceV2.checkTokenSource(tokenSource, requestSource, source)) {
                log.error("TOKEN_TYPE_MISMATCH - tokenSource : {}, requestSource : {}, paramSource : {}, cartOrderModel : {}",
                        tokenSource, requestSource, source, cartOrderModel);
                HashMap<String, String> customAttributes = new HashMap<>();
                CommonUtils.noticeError("TokenTypeMismatchException", customAttributes, Boolean.FALSE);
                gatewayService.logoutUserAll(userIdFinal);
                throw new CreateOrderNotAcceptableException("Token mismatch Error", CreateOrderExceptionType.TOKEN_MISMATCH_EXCEPTION);
            }
            if(!StringUtils.isEmpty(appVersion) && commonUtils.checkAppVersion(appVersion, cartOrderModel.getSource(), source) && !platform.equals(IOS)) {
                log.error("ABUSE_VERSION_DETECTED - version : {}, userId : {}, cartId : {}",appVersion, cartOrderModel.getUserId(), cartOrderModel.getCartId());
                gatewayService.logoutUserAll(userIdFinal);
                throw new CreateOrderNotAcceptableException("Abuse Version Detected", CreateOrderExceptionType.ABUSE_VERSION_ERROR);
            }
        }
        catch (CreateOrderNotAcceptableException e) {

--- cart-service | CartControllerV2 | placeOrder | CODE | 2/2 ---
                gatewayService.logoutUserAll(userIdFinal);
                throw new CreateOrderNotAcceptableException("Abuse Version Detected", CreateOrderExceptionType.ABUSE_VERSION_ERROR);
            }
        }
        catch (CreateOrderNotAcceptableException e) {
            throw e;
        }
        catch (Exception e){
            log.error("userId {} cartId {}. Exception in Place order V2 : {}, cartOrderModel : {}, authKey : {}, stackTrace : {}", cartOrderModel.getUserId(),
                    cartOrderModel.getCartId(), e.getMessage(), cartOrderModel, authKey, e.getMessage());
        }

        Long longPalId = null;
        if(palId != null){
            longPalId = palId.longValue();
        }

        CartParamsTransferModelDTO cartParams = new CartParamsTransferModelDTO(appsFlyerId, deviceId, platform, cartOrderModel.getIsCodFirstPurchase(), advertisingId,cartOrderModel.getIsOfflineToOnlineConversion(),addressId,longPalId, instanceId);

        try {


ðŸ“„ FILE: CartController.java

--- cart-service | CartController | addProduct | CODE | 1/1 ---
  @Deprecated
  @PostMapping("/add-product")
  public ResponseEntity<?> addProduct(@Valid @RequestBody CartRequestModel cartRequestModel,
                                      @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                      @RequestParam(name = "userId", required = false) Long userId,
                                      @RequestHeader(value = "appVersion", required = false) String appVersion,
                                      HttpServletRequest request) throws Exception {
    Long userIdFinal = commonUtils.getFinalValidUserId(request, userId);
//        cartServiceV2.addProductToCart(cartRequestModel, source, null, userIdFinal, appVersion);
    return new ResponseEntity<>(HttpStatus.NO_CONTENT);

--- cart-service | CartController | updateProduct | CODE | 1/1 ---
  @Deprecated
  @PutMapping("/update-product")
  public ResponseEntity<?> updateProduct(@Valid @RequestBody CartRequestModel cartRequestModel,
                                         @RequestParam(value = "source", defaultValue = "B2C", required = false)
                                         String source,
                                         @RequestParam(name = "userId", required = false) Long userId,
                                         @RequestHeader(value = "pincode", required = false) String pincode,
                                         @RequestHeader(value = "appVersion", required = false) String appVersion,
                                         HttpServletRequest request) throws Exception {
    Long userIdFinal = commonUtils.getFinalValidUserId(request, userId);
//        cartServiceV2.updateProductToCart(cartRequestModel, source, userIdFinal,pincode,appVersion);
    return new ResponseEntity<>(HttpStatus.NO_CONTENT);

--- cart-service | CartController | getCart | CODE | 1/1 ---
  @Deprecated
  @RateLimiter(name = "getProductsRateLimiter")
  @PostMapping("/get-products")
  public ResponseEntity<?> getCart(@Valid @RequestBody GetCartRequestModel getCartRequestModel,
                                   @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                   @RequestHeader(name = "lang", defaultValue = "en") String lang,
                                   @RequestHeader(value = "Authorization", required = false) String authKey,
                                   @RequestParam(name = "userId", required = false) Long userId,
                                   HttpServletRequest request) throws Exception {
//        Long userIdFinal = commonUtils.getFinalValidUserId(request, userId);
//        cartServiceV2.getCart(getCartRequestModel, source, lang, userIdFinal, authKey)
    return new ResponseEntity<>(new UserCart(), HttpStatus.OK);

--- cart-service | CartController | addAddress | CODE | 1/1 ---
  @PostMapping("/user/address")
  public ResponseEntity<?> addAddress(@Valid @RequestBody AddressModel address,
                                      @RequestParam(name = "userId", required = false) Long userId,
                                      @RequestHeader(name = "userId", required = false) Long headerUserId,
                                      @RequestHeader(name = "appVersion", required = false, defaultValue = "1.1.5") String appVersion,
                                      @RequestHeader(name = "palId", required = false) Long browsingPalId,
                                      HttpServletRequest request,
                                      @RequestHeader(name = "platform", defaultValue = ANDROID, required = false) String platform) throws Exception {
    Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
    address.setUserId(userIdFinal);
//    if (Objects.nonNull(request.getAttribute(RequestAttributeConstant.APP_VERSION))) {
//      appVersion = (String) request.getAttribute(RequestAttributeConstant.APP_VERSION);
//    }
    return new ResponseEntity<>(userService.addAddress(address, appVersion, browsingPalId, platform), HttpStatus.OK);

--- cart-service | CartController | placeOrder | CODE | 1/2 ---
  @PostMapping("/order")
  public ResponseEntity<?> placeOrder(@RequestBody CartOrderModel cartOrderModel,
                                      @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                      @RequestHeader(value = "lang", defaultValue = "en") String lang,
                                      @RequestHeader(value = "Authorization") String authKey,
                                      @RequestHeader(value = "Authorization-Refresh",  required = false) String authorizationRefresh,
                                      @RequestHeader(value = "cpVersion", defaultValue = "0", required = false) int cpVersion,
                                      @RequestParam(value = "userId", required = false) Long userId,
                                      @RequestHeader(value = "pincode", required = false) String pincode,
                                      HttpServletRequest request,
                                      @RequestHeader(value = "platform", defaultValue = ANDROID, required = false) String platform,
                                      @RequestHeader(value = "Appsflyer-Uid", required = false) String appsFlyerId,
                                      @RequestHeader(value = "deviceId" , required = false) String deviceId,
                                      @RequestHeader(value = "advertisingId" ,defaultValue = "", required = false) String advertisingId,
                                      @RequestHeader(value = "instanceId" ,defaultValue = "", required = false) String instanceId,
                                      @RequestHeader(value = "palId", defaultValue = "", required = false) Long palId) throws Exception {
    Long userIdFinal = commonUtils.getFinalValidUserId(request, userId);
    String appVersion = null;
    try {
      String tokenSource = (String) request.getAttribute(RequestAttributeConstant.TOKEN_SOURCE);
      appVersion = (String) request.getAttribute(RequestAttributeConstant.APP_VERSION);
      if (appVersion.equalsIgnoreCase("B2B")) {
        log.error("Wrong app version : {}, requestAttribute : {}", appVersion, request);
      }
      String requestSource = cartOrderModel.getSource();
      if (StringUtils.isEmpty(tokenSource)) {
//                log.error("EMPTY_TOKEN_SOURCE_RECEIVED - cartOrderModel : {}", cartOrderModel);
      } else if (!cartServiceV2.checkTokenSource(tokenSource, requestSource, source)) {
        log.error("TOKEN_TYPE_MISMATCH - tokenSource : {}, requestSource : {}, paramSource : {}, cartId : {}, userId : {}",
                tokenSource, requestSource, source, cartOrderModel.getCartId(), cartOrderModel.getUserId());
        HashMap<String, String> customAttributes = new HashMap<>();
        CommonUtils.noticeError("TokenTypeMismatchException", customAttributes, Boolean.FALSE);
        gatewayService.logoutUserAll(userIdFinal);
        return new ResponseEntity<>(HttpStatus.BAD_REQUEST);
      }

    } catch (Exception e) {
      log.error("Exception in Place order V1 : {}, cartOrderModel : {}, authKey : {}", e.getMessage(), cartOrderModel, authKey);
    }
    CartParamsTransferModelDTO cartParams = new CartParamsTransferModelDTO(appsFlyerId, deviceId, platform, cartOrderModel.getIsCodFirstPurchase(), advertisingId,cartOrderModel.getIsOfflineToOnlineConversion(),null,palId, instanceId);
    CartOrderModel cartOrderModel1 =  cartServiceV2.placeOrderV2(cartOrderModel, lang, source, userIdFinal, cpVersion, pincode, appVersion, null, platform, authorizationRefresh, appsFlyerId, deviceId,cartParams);
    cartParams.setIsFirstPurchase(cartOrderModel.getIsCodFirstPurchase());
    cartParams.setIsOfflineToOnlineFirstPurchase(cartOrderModel.getIsOfflineToOnlineConversion());
    cartServiceV2.raisePostOrderEvents(cartOrderModel1, userIdFinal, source, cartParams);
    return new ResponseEntity<>(cartOrderModel1, HttpStatus.OK);


ðŸ“„ FILE: CartControllerV3.java

--- cart-service | CartControllerV3 | addProduct | CODE | 1/1 ---
    @PostMapping("/add-product")
    public ResponseEntity<?> addProduct(@Valid @RequestBody CartRequestModel cartRequestModel,
                                        @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                        @RequestHeader(value = "appVersion", required = false) String appVersion,
                                        @RequestParam(name = "userId", required = false) Long userId,
                                        HttpServletRequest request,
                                        @RequestHeader(value = "platform", defaultValue = ANDROID , required = false) String platform,
                                        @RequestHeader(name = "userId", required = false) Long headerUserId) throws Exception {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        return new ResponseEntity<>(cartServiceV3.addProductToCart(cartRequestModel, source, userIdFinal, appVersion, platform), HttpStatus.CREATED);


ðŸ“„ FILE: CartConfigController.java

--- cart-service | CartConfigController | cartConfig | CODE | 1/1 ---
    @RateLimiter(name = "ordDeliveryConfigRateLimiter")
    @GetMapping(value = "/ord-delivery-fee-config")
    public  ResponseEntity<?> cartConfig(@RequestParam(value = "userId")Long userId,
                                         @RequestParam(value = "phone") String phone,
                                         @RequestParam(value = "pincode") String pincode,
                                         @RequestParam(value = "userRank") String userRank,
                                         @RequestParam(value = "source", defaultValue = "B2C", required = false) String source,
                                         @RequestParam(value = "clusterIds") List<Integer> clusterIds,
                                         @RequestHeader(value = "Accept-Language", defaultValue = "en", required = false) String lang
                                         ) {
        return new ResponseEntity<>(cartConfigService.getCartConfig(userId,


ðŸ“„ FILE: UserCartController.java

--- cart-service | UserCartController | getUserCarts | CODE | 1/1 ---
    @GetMapping("/carts")
    public ResponseEntity<?> getUserCarts(@PathVariable(name = "phone") @Pattern(regexp = "^[0-9]{10}$") String phone,
                                          @RequestHeader(name = "source", defaultValue = "B2C") AppSource source,
                                          @RequestHeader(name = "cartStatus", defaultValue = "Active") UserCartStatus cartStatus,
                                          @RequestHeader(name = "lang", defaultValue = "en") String lang,
                                          @RequestHeader(name = "cartType", defaultValue = "Cart") UserCartType cartType,
                                          @RequestParam(name = "pageNo", defaultValue = "0") Integer pageNo,
                                          @RequestParam(name = "pageSize", defaultValue = "5") Integer pageSize,
                                          @RequestParam(name = "userId", required = false) Long userId,
                                          @RequestHeader(name = "userId", required = false) Long headerUserId,
                                          HttpServletRequest request) {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        return ResponseEntity.ok(this.service.getAllCarts(phone, source, lang, cartStatus, cartType, pageNo, pageSize, userIdFinal));

--- cart-service | UserCartController | getUserOrders | CODE | 1/1 ---
    @GetMapping("/orders")
    public ResponseEntity<?> getUserOrders(@PathVariable(name = "phone") @Pattern(regexp = "^[0-9]{10}$") String phone,
                                           @RequestHeader(name = "source",defaultValue = "B2C") AppSource source,
                                           @RequestHeader(name ="cartStatus") UserCartStatus cartStatus,
                                           @RequestHeader(name= "userId") Long userId,
                                           @RequestHeader(name="pageNo", defaultValue = "0") Integer pageNo,
                                           @RequestHeader(name = "lang", defaultValue = "en") String lang,
                                           @RequestHeader(name = "pincode") String pincode,
                                           @RequestParam(name = "pageSize",defaultValue = "10") Integer pageSize,
                                           @RequestHeader(value = "Authorization") String authKey) throws IOException {
        return ResponseEntity.ok(this.service.getAllOrders(phone,source,cartStatus,userId,pageNo,lang,pincode,pageSize,authKey));

--- cart-service | UserCartController | getUserCart | CODE | 1/1 ---
    @GetMapping("/cart/{id}")
    public ResponseEntity<?> getUserCart(@PathVariable(name = "phone") @Pattern(regexp = "^[0-9]{10}$") String phone,
                                         @RequestHeader(name = "cartType", defaultValue = "Cart") UserCartType cartType,
                                         @Valid @PathVariable(name = "id") @Min(1) Long id,
                                         @RequestHeader(name = "lang", defaultValue = "en") String lang,
                                         @RequestHeader(name = "pincode") String pincode,
                                         @RequestHeader(name = "appVersion") String appVersion,
                                         @RequestHeader(value = "Authorization") String authKey,
                                         @RequestParam(name = "userId", required = false) Long userId,
                                         @RequestHeader(name = "userId", required = false) Long headerUserId,
                                         @RequestHeader(name = "appType", required = false) String appType,
                                         HttpServletRequest request,
                                         @RequestHeader(name = "platform", defaultValue = ANDROID, required = false) String platform) throws IOException {
        Long userIdFinal = Objects.isNull(headerUserId) ? commonUtils.getFinalValidUserId(request, userId) : headerUserId;
        String source = ObjectUtils.isEmpty(appType)
                ? (String) request.getAttribute(RequestAttributeConstant.TOKEN_SOURCE) : appType;
        return ResponseEntity.ok(this.service.getCartDetails(phone, cartType, id, lang, pincode,


ðŸ“„ FILE: CartUpdateServiceV1.java

--- cart-service | CartUpdateServiceV1 | updateCart | CODE | 1/2 ---
    @Override
    public UserCartResponseModel updateCart(CartUpdateRequestModel cartUpdateRequestModel,
                                     Long userId,
                                     String source,
                                     String lang,
                                     String appVersion,
                                     String pincode,
                                     Integer palId, Boolean juspayEnabled, CartParamsTransferModelDTO cartParamsTransferModelDTO){

        if(ObjectUtils.isEmpty(cartUpdateRequestModel.getApplyWalletCashback())){
            cartUpdateRequestModel.setApplyWalletCashback(false);
        }
        if(ObjectUtils.isEmpty(cartUpdateRequestModel.getApplyRefund())){
            cartUpdateRequestModel.setApplyRefund(false);
        }
        /** user validation */
        Pair<UserCacheModel, LocationV3Model> userLocationPair = userLocationService
                .populateUserAndLocationDetails(userId, pincode, palId, source);
        UserCacheModel userCacheModel = userLocationPair.getLeft();
        LocationV3Model locationV3Model = userLocationPair.getRight();
        if(Objects.isNull(userCacheModel.getPincode())){
            log.error("during cart Post,userCache having null pinCode, userId: {}, userCacheModel: {} ", userId, userCacheModel);
            userServiceClientWrapper.deleteUserCache(userId);
            userCacheModel = userService.performUserValidation(userId, source);
        }else if(Objects.isNull(cartUpdateRequestModel.getPincode())){
            log.error("during cart Post, pincode not present in request for userId: {}, userRequestModel: {},userCache : {}", userId, cartUpdateRequestModel,userCacheModel);
            throw new ValidationException(ExceptionMessages.VALID_PINCODE_REQUIRED.getValue());
        }

        if(Objects.isNull(userCacheModel.getPincode())){
            log.error("during cart Post, userCache having null pinCode, userId: {}, userCacheModel: {} ", userId, userCacheModel);
            throw new ValidationException(ExceptionMessages.VALID_PINCODE_REQUIRED.getValue());
        }
        userCacheModel.setLang(StringUtils.isEmpty(lang) ? Language.DEFAULT.getValue() : lang.trim());
        userCacheModel.setPalId(palId == null ? null : palId.longValue());

        /** pincode mismatch validation */
        commonUtils.performPincodeMismatchValidation(appVersion,
                userCacheModel.getPincode().toString(),
                cartUpdateRequestModel.getPincode().toString(),
                cartParamsTransferModelDTO.getPlatform());

        if (ObjectUtils.isEmpty(cartUpdateRequestModel.getCartId())) {
            log.error("Cart Id not present for User : {}", userId);
            throw new CartNotFoundException(ExceptionMessages.CART_ID_NOT_VALID.getValue());
        }

        Pair<CartUpdateResponseModel, UserCartV2Model> result = cartServiceV4.getUserCartV2ModelWithResponse(cartUpdateRequestModel, appVersion, palId, cartParamsTransferModelDTO.getPlatform(), cartParamsTransferModelDTO.getDeviceId(), cartParamsTransferModelDTO.getAppsFlyerId(), cartParamsTransferModelDTO.getAdvertisingId(), userCacheModel, locationV3Model,cartParamsTransferModelDTO);
        UserCartV2Model userCartV2Model = result.getRight();
        CartUpdateResponseModel cartUpdateResponseModel = result.getLeft();

--- cart-service | CartUpdateServiceV1 | updateCart | CODE | 2/2 ---
        }

        Pair<CartUpdateResponseModel, UserCartV2Model> result = cartServiceV4.getUserCartV2ModelWithResponse(cartUpdateRequestModel, appVersion, palId, cartParamsTransferModelDTO.getPlatform(), cartParamsTransferModelDTO.getDeviceId(), cartParamsTransferModelDTO.getAppsFlyerId(), cartParamsTransferModelDTO.getAdvertisingId(), userCacheModel, locationV3Model,cartParamsTransferModelDTO);
        UserCartV2Model userCartV2Model = result.getRight();
        CartUpdateResponseModel cartUpdateResponseModel = result.getLeft();

        if(userId == 25475135){
            log.error("User Cart Update Request : {}", cartUpdateRequestModel);
            log.error("User Cart Response : {}", userCartV2Model);
            log.error("locationV3Model : {}", locationV3Model);
            log.error("userCacheModel : {}", userCacheModel);
        }

        try{
            Boolean doesRequestContainFreeDeal = doesRequestContainFreeDeal(cartUpdateRequestModel,userCartV2Model);
            if(!doesRequestContainFreeDeal) {
                userCartV2Model = cartServiceV4.HandleUpdateCartFreeDealLogic(userCartV2Model, locationV3Model, source, cartUpdateRequestModel, userCacheModel, cartParamsTransferModelDTO, appVersion, palId);
            }
            RemoveFreeDeals(userCartV2Model);
        }catch (Exception e){
            log.error("Error in HandleCartUpdateFreeDealLogic: msg : {}", e.getMessage(),e);
        }


        if(Objects.nonNull(userCartV2Model)) {
            List<SavedPaymentMethods> savedPaymentMethods = paymentServiceClient.getSavedPaymentMethodsFromCache(SavedPaymentMethodsCacheRequestModel.builder()
                    .cartValue(userCartV2Model.getCartPricingSummaryModel().getTotalPrice().doubleValue())
                    .juspayEnabled(juspayEnabled)
                    .userRank(userCacheModel.getUserRank())
                    .userId(userCacheModel.getId())
                    .build());
            userCartV2Model.setSavedPaymentMethodsList(savedPaymentMethods);
        }
        return userCartResponseMapper.mapEntityToModel(userCartV2Model);
